<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Flow - M3: Balancing Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* --- Enterprise Theme Palette (Slate/Emerald) --- */
            --bg-app: #f1f5f9;       /* Slate 100 */
            --bg-card: #ffffff;      /* White */
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #475569; /* Slate 600 */
            --border-light: #e2e8f0;
            --border-strong: #cbd5e1;
            
            /* Navigation Colors */
            --nav-bg: #1e293b;       /* Slate 800 */
            --nav-text: #f8fafc;     /* Slate 50 */
            --nav-active: #3b82f6;   /* Blue 500 */

            /* Module Identity (Balancing = Emerald) */
            --module-accent: #059669; 
            --module-light: #d1fae5;
            
            /* Flowchart Node Color Mapping */
            --node-doc: #9333ea;      /* Purple (Document) */
            --bg-doc: #faf5ff;
            --node-event: #d97706;    /* Amber (Event/Workbench) */
            --bg-event: #fffbeb;
            --node-hub: #059669;      /* Green (Hub/Calc) */
            --bg-hub: #ecfdf5;

            --radius: 8px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Inter, system-ui, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            padding-bottom: 80px;
        }

        /* --- Navigation --- */
        .nav-bar {
            background-color: var(--nav-bg);
            padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-container {
            max-width: 1400px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        .nav-brand { font-weight: 700; color: white; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 5px; }
        .nav-link {
            text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 0.9rem;
            padding: 8px 12px; border-radius: 4px; transition: all 0.2s;
        }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-link.active { background: var(--nav-active); color: white; }

        /* --- Header --- */
        .header-section {
            background: white; border-bottom: 1px solid var(--border-light);
            padding: 40px 20px; text-align: center; margin-bottom: 40px;
        }
        .header-content { max-width: 1200px; margin: 0 auto; }
        .module-badge {
            background: var(--module-light); color: var(--module-accent);
            padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;
            text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; margin-bottom: 15px;
        }
        h1 { font-size: 2.2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; }
        .header-desc { color: var(--text-secondary); max-width: 800px; margin: 0 auto; line-height: 1.6; }

        /* --- Layout --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        .workbench-grid {
            display: grid; grid-template-columns: 6.5fr 3.5fr; gap: 25px; margin-bottom: 40px;
            transition: opacity 0.5s ease;
        }

        /* --- Node Cards --- */
        .step-card {
            background: var(--bg-card); border-radius: var(--radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-card);
            display: flex; flex-direction: column; overflow: hidden;
            height: 100%;
        }

        /* Theme Mapping */
        .node-event { border-top: 5px solid var(--node-event); } /* Yellow */
        .node-event .card-header { background: var(--bg-event); color: var(--node-event); }

        .node-doc { border-top: 5px solid var(--node-doc); } /* Purple */
        .node-doc .card-header { background: var(--bg-doc); color: var(--node-doc); }
        
        .node-draft { border-top: 5px dashed var(--node-doc); } /* Dashed Purple */
        .node-draft .card-header { background: #ffffff; color: var(--text-secondary); border-bottom: 1px dashed var(--border-light); }

        .card-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .card-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; line-height: 1.5; }

        /* --- Suggestion Panel (The Solver) --- */
        .suggestion-panel {
            background: white; border: 2px solid var(--node-event); border-radius: var(--radius);
            margin-bottom: 40px; overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(217, 119, 6, 0.15);
        }
        .panel-header {
            background: var(--bg-event); padding: 15px 25px; border-bottom: 1px solid #fcd34d;
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-title { color: #92400e; font-weight: 700; font-size: 1.1rem; display: flex; gap: 10px; align-items: center; }
        
        .panel-body { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        .option-card {
            border: 1px solid var(--border-light); border-radius: 8px; padding: 20px;
            transition: all 0.2s; position: relative; display: flex; flex-direction: column;
        }
        .option-card:hover { border-color: var(--node-event); transform: translateY(-2px); box-shadow: var(--shadow-card); }
        
        .option-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .option-title { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        
        /* Score Badges */
        .score-badge { padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; }
        .score-high { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .score-med { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }

        .score-explain { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 15px; font-style: italic; text-align: right; display: block; }

        .option-details { flex: 1; }
        .option-details p { margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); display: flex; justify-content: space-between; }
        .option-details strong { color: var(--text-primary); }

        .select-btn {
            width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--node-event); color: white; box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.3); }
        .btn-primary:hover { background: #b45309; transform: translateY(-1px); }
        
        .btn-secondary { background: white; color: var(--text-secondary); border: 1px solid var(--border-strong); }
        .btn-secondary:hover { background: #f8fafc; border-color: var(--text-secondary); color: #1e293b; }

        /* --- Data Tables --- */
        .table-wrapper { border: 1px solid var(--border-strong); border-radius: 6px; overflow: hidden; max-height: 300px; overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th {
            background: #e2e8f0; color: var(--text-primary); font-weight: 700;
            padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--border-strong);
            position: sticky; top: 0; z-index: 10; white-space: nowrap;
        }
        td { padding: 8px 12px; border-bottom: 1px solid var(--border-light); color: #334155; white-space: nowrap; }
        tr:nth-child(even) { background: #f8fafc; }
        
        /* --- Badges --- */
        .pk { background: #fee2e2; color: #991b1b; padding: 1px 4px; border-radius: 3px; font-size: 0.7em; margin-left: 4px; border: 1px solid #fca5a5; }
        .fk { background: #dbeafe; color: #1e40af; padding: 1px 4px; border-radius: 3px; font-size: 0.7em; margin-left: 4px; border: 1px solid #93c5fd; }

        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .badge-covered { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-uncovered { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-transit { background: #e0e7ff; color: #3730a3; border: 1px solid #a5b4fc; }
        .badge-ordered { background: #f3f4f6; color: #4b5563; border: 1px solid #cbd5e1; font-style: italic; }
        .badge-rush { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        
        /* --- Footer Logic --- */
        .logic-footer { margin-top: 40px; background: white; border: 1px solid var(--border-light); border-radius: var(--radius); padding: 25px; }
        .logic-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 15px; }
        .logic-item h4 { color: var(--module-accent); margin-bottom: 8px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .logic-item p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
        .logic-formula { background: #f8fafc; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; border: 1px solid #e2e8f0; margin-top: 5px; color: #334155; }
        
        /* --- Results Divider --- */
        .flow-divider {
            display: flex; align-items: center; justify-content: center; margin: 30px 0; color: var(--text-secondary);
            font-weight: 700; font-size: 0.9rem;
        }
        .flow-divider::before, .flow-divider::after {
            content: ''; height: 1px; background: var(--border-strong); width: 100%; margin: 0 20px;
        }

        /* --- Nav Footer --- */
        .page-footer {
            max-width: 1400px; margin: 20px auto; padding: 20px;
            background: white; border-radius: var(--radius); border: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .footer-btn { text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-prev { background: var(--bg-app); color: var(--text-secondary); }
        .btn-next { background: var(--nav-active); color: white; }

    </style>
</head>
<body>

    <nav class="nav-bar">
        <div class="nav-container">
            <div class="nav-brand"><i class="fas fa-cubes"></i> ISC Supply Chain</div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="module1.html" class="nav-link">M1: Planning</a>
                <a href="module2.html" class="nav-link">M2: Procurement</a>
                <a href="module3.html" class="nav-link active">M3: Balancing</a>
                <a href="module4.html" class="nav-link">M4: Inbound</a>
                <a href="module5.html" class="nav-link">M5: Inventory</a>
                <a href="module6.html" class="nav-link">M6: Control</a>
                <a href="module7.html" class="nav-link">M7: Finance</a>
            </div>
        </div>
    </nav>

    <section class="header-section">
        <div class="header-content">
            <span class="module-badge">Module 3</span>
            <h1><i class="fas fa-balance-scale"></i> Supply & Demand Balancing</h1>
            <p class="header-desc">
                The "Brain" of the system. M3 matches Supply to Demand using smart logic.
                <strong>v16.2 Upgrade:</strong> Compare strategies: "Cross-Docking" (Time Focus) vs. "Expediting" (Stability Focus).
            </p>
        </div>
    </section>

    <div class="container">

        <div id="step-1-container" class="workbench-grid">
            <div class="step-card node-event">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-calculator"></i> 1. Material_Demand_Balancing</div>
                    <span class="badge badge-covered">Status: Stable</span>
                </div>
                <div class="card-body">
                    <p class="card-desc">
                        Initial Calculation. <code>PO-100</code> (In-Transit) is covering C03. <code>PO-101</code> (Ordered) is covering C04.
                        <br><strong>Emergency:</strong> C05 has arrived with an immediate need for Dec 12.
                    </p>
                    <div class="table-wrapper"><table id="table-bal-init"></table></div>
                </div>
            </div>

            <div class="step-card node-doc">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-link"></i> 2. PURCHASE_ORDER_ID_VPO_Pegging</div>
                </div>
                <div class="card-body">
                    <p class="card-desc">Current Supply Allocations. <br><code>PO-100</code> &rarr; <code>VPO-C03</code>.</p>
                    <div class="table-wrapper"><table id="table-peg-init"></table></div>
                </div>
            </div>
        </div>

        <div id="step-2-container" class="suggestion-panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-robot"></i> Manage_Pegging: Smart Allocation Workbench</div>
                <span class="badge badge-uncovered" style="background:white; border:1px solid #b45309; color:#b45309;">ALERT: Emergency Order VPO-C05 (Due Dec 12)</span>
            </div>
            <div class="panel-body">
                
                <div class="option-card" id="card-opt-a" style="border: 2px solid #059669;">
                    <div class="option-header">
                        <div class="option-title">Option A: Cross-Dock</div>
                        <span class="score-badge score-high">Fit Score: 98%</span>
                    </div>
                    <span class="score-explain">Reason: Perfect Date Match (+50%), No Cost (+30%)</span>
                    <div class="option-details">
                        <p><span>Source:</span> <strong>PO-100 (In-Transit)</strong></p>
                        <p><span>Arrival:</span> <strong>Dec 12 (On Time)</strong></p>
                        <p><span>Cost:</span> <span style="color:#15803d">$0 (Labor Only)</span></p>
                        <p><span>Impact:</span> <span style="color:#b45309">Displaces VPO-C03</span></p>
                    </div>
                    <button class="select-btn btn-primary" id="btn-opt-a"><i class="fas fa-check"></i> Select Option A</button>
                </div>

                <div class="option-card" id="card-opt-b">
                    <div class="option-header">
                        <div class="option-title">Option B: Expedite</div>
                        <span class="score-badge score-med">Fit Score: 45%</span>
                    </div>
                    <span class="score-explain">Reason: Late Arrival (-20%), High Cost (-35%)</span>
                    <div class="option-details">
                        <p><span>Source:</span> <strong>PO-101 (Ordered)</strong></p>
                        <p><span>Arrival:</span> <strong>Dec 14 (Rush needed)</strong></p>
                        <p><span>Cost:</span> <span style="color:#b91c1c">$$$ (Air Freight)</span></p>
                        <p><span>Impact:</span> <span style="color:#15803d">Low Disruption (C03 Safe)</span></p>
                    </div>
                    <button class="select-btn btn-secondary" id="btn-opt-b">Select Option B</button>
                </div>

            </div>
        </div>

        <div id="sim-divider" class="flow-divider" style="display:none;">SIMULATION RESULTS</div>

        <div id="step-3-container" class="workbench-grid" style="display:none;">
            <div class="step-card node-event">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-sync-alt"></i> 3. Updated Balancing (<span id="res-title-text"></span>)</div>
                    <span class="badge badge-covered">Re-Calculated</span>
                </div>
                <div class="card-body">
                    <p class="card-desc" id="res-desc-text">...</p>
                    <div class="table-wrapper"><table id="table-bal-after"></table></div>
                </div>
            </div>

            <div class="step-card node-doc">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-link"></i> 4. PURCHASE_ORDER_ID_VPO_Pegging (Updated)</div>
                </div>
                <div class="card-body">
                    <p class="card-desc">New hard allocations committed to database.</p>
                    <div class="table-wrapper"><table id="table-peg-after"></table></div>
                </div>
            </div>
        </div>

        <div id="step-4-container" class="step-card node-draft" style="margin-bottom: 0; display:none;">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-clipboard-list"></i> 5. Generates: Purchase_Request_Draft</div>
                <span class="badge badge-ordered">To Procurement</span>
            </div>
            <div class="card-body">
                <p class="card-desc">Final Requirement List. VPO-C04 is sent back to Module 2 to buy new stock.</p>
                <div class="table-wrapper"><table id="table-net-demand"></table></div>
            </div>
        </div>

        <div class="logic-footer">
            <h3 style="margin-bottom: 15px; color:var(--text-primary);"><i class="fas fa-book"></i> Logic & Data Definitions</h3>
            <div class="logic-grid">
                <div class="logic-item">
                    <h4><i class="fas fa-balance-scale-right"></i> Fit Score Algorithm</h4>
                    <p>The system calculates "Best Option" based on weighted factors:</p>
                    <div class="logic-formula">Score = (Date_Match * 50%) + (Qty_Match * 30%) - (Cost_Penalty * 20%)</div>
                </div>
                <div class="logic-item">
                    <h4><i class="fas fa-truck-loading"></i> Cross-Dock vs Expedite</h4>
                    <p><strong>Cross-Dock (Option A):</strong> Steal In-Transit stock. Low cost, high disruption to existing orders. <br><strong>Expedite (Option B):</strong> Rush an open PO. High cost (air freight), but keeps existing plans stable.</p>
                </div>
                <div class="logic-item">
                    <h4><i class="fas fa-database"></i> Table Integrity</h4>
                    <p><code>PURCHASE_ORDER_ID_VPO_Pegging</code> is the Many-to-Many link table. It retains <code>PO_LINE_ID</code> in the composite key to handle split deliveries.</p>
                </div>
            </div>
        </div>

    </div>

    <footer class="page-footer">
        <a href="module2.html" class="footer-btn btn-prev"><i class="fas fa-arrow-left"></i> Previous: M2 Procurement</a>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">ISC Data Engineering â€¢ v16.2 Simulation</div>
        <a href="module4.html" class="footer-btn btn-next">Next: M4 Inbound <i class="fas fa-arrow-right"></i></a>
    </footer>

    <script>
        // --- DATASETS (v16.2 - Dual Scenarios) ---
        const tsvData = {
            balInit: `REQ_DATE\tTYPE\tVPO\tBOM_UPDATE\tGROSS_DEMAND\tSUPPLY\tARRIVAL\tSTATUS\n12-Dec\tSTOCK\t(OnHand)\t300010406C\t0\t6000\tN/A\t<span class="badge badge-covered">Available</span>\n13-Dec\tDEMAND\tVPO-C03\t300010406C\t14040\t0\t-\t<span class="badge badge-covered">Covered (PO-100)</span>\n(PO)\tSUPPLY\tPO-100\t300010406C\t0\t52242\t12-Dec\t<span class="badge badge-transit">Supply (In-Transit)</span>\n14-Dec\tDEMAND\tVPO-C04\t300010406C\t14040\t0\t-\t<span class="badge badge-covered">Covered (PO-101)</span>\n(PO)\tSUPPLY\tPO-101\t300010406C\t0\t33987\t14-Dec\t<span class="badge badge-ordered">Supply (Ordered)</span>\n12-Dec\tDEMAND\tVPO-C05\t300010406C\t14040\t0\t-\t<span class="badge badge-uncovered">UNCOVERED (URGENT)</span>`,
            pegInit: `PO_ID\tPO_LINE_ID\tPEGGED_VPO\tBOM_UPDATE\tPEGGED_QTY\nPO-100\t1\tVPO-C03\t300010406C\t8040\nPO-101\t1\tVPO-C04\t300010406C\t14040\nPO-101\t2\tVPO-C01\t300010406C\t12667`,
            
            // SCENARIO A: CROSS-DOCK (Steal PO-100)
            balAfterA: `REQ_DATE\tTYPE\tVPO\tBOM_UPDATE\tGROSS_DEMAND\tSUPPLY\tARRIVAL\tSTATUS\n12-Dec\tSTOCK\t(OnHand)\t300010406C\t0\t6000\tN/A\t<span class="badge badge-covered">Available</span>\n13-Dec\tDEMAND\tVPO-C03\t300010406C\t14040\t0\t-\t<span class="badge badge-covered">Covered (Stole PO-101)</span>\n12-Dec\tDEMAND\tVPO-C05\t300010406C\t14040\t0\t-\t<span class="badge badge-covered">Covered (Stole PO-100)</span>\n14-Dec\tDEMAND\tVPO-C04\t300010406C\t14040\t0\t-\t<span class="badge badge-uncovered">UNCOVERED (Victim)</span>`,
            pegAfterA: `PO_ID\tPO_LINE_ID\tPEGGED_VPO\tBOM_UPDATE\tPEGGED_QTY\nPO-100\t1\tVPO-C05\t300010406C\t14040\nPO-101\t1\tVPO-C03\t300010406C\t8040\nPO-101\t2\tVPO-C01\t300010406C\t12667`,
            
            // SCENARIO B: EXPEDITE (Steal PO-101 & Rush it)
            // Logic: PO-101 moves to Dec 12 (Expedited). PO-100 stays on Dec 12 (Stable). C03 is safe.
            balAfterB: `REQ_DATE\tTYPE\tVPO\tBOM_UPDATE\tGROSS_DEMAND\tSUPPLY\tARRIVAL\tSTATUS\n12-Dec\tSTOCK\t(OnHand)\t300010406C\t0\t6000\tN/A\t<span class="badge badge-covered">Available</span>\n13-Dec\tDEMAND\tVPO-C03\t300010406C\t14040\t0\t-\t<span class="badge badge-covered">Covered (Kept PO-100)</span>\n12-Dec\tDEMAND\tVPO-C05\t300010406C\t14040\t0\t12-Dec\t<span class="badge badge-rush">Covered (Expedited PO-101)</span>\n14-Dec\tDEMAND\tVPO-C04\t300010406C\t14040\t0\t-\t<span class="badge badge-uncovered">UNCOVERED (Victim)</span>`,
            pegAfterB: `PO_ID\tPO_LINE_ID\tPEGGED_VPO\tBOM_UPDATE\tPEGGED_QTY\nPO-100\t1\tVPO-C03\t300010406C\t8040\nPO-101\t1\tVPO-C05\t300010406C\t14040\nPO-101\t2\tVPO-C01\t300010406C\t12667`,
            
            netDemand: `VPO\tBOM_UPDATE\tREQ_DATE\tNET_DEMAND\nVPO-C04\t300010406C\t14-Dec-2025\t14040.00`
        };

        // --- RENDER LOGIC ---
        function renderTable(tableId, tsvString, headers, keyConfig) {
            const tableEl = document.getElementById(tableId);
            if(!tableEl) return;
            const lines = tsvString.trim().split('\n');
            const data = lines.map(line => {
                const vals = line.split('\t');
                let obj = {};
                headers.forEach((h, i) => obj[h] = vals[i] || '');
                return obj;
            });

            let thead = '<thead><tr>';
            headers.forEach(h => {
                let badge = '';
                if (keyConfig.pk && keyConfig.pk.includes(h)) badge = '<span class="pk">PK</span>';
                if (keyConfig.fk && keyConfig.fk.includes(h)) badge = '<span class="fk">FK</span>';
                thead += `<th>${h.replace(/_/g, ' ')} ${badge}</th>`;
            });
            thead += '</tr></thead>';

            let tbody = '<tbody>';
            data.forEach(row => {
                tbody += '<tr>';
                headers.forEach(h => tbody += `<td>${row[h]}</td>`);
                tbody += '</tr>';
            });
            tbody += '</tbody>';

            tableEl.innerHTML = thead + tbody;
        }

        // --- INTERACTIVITY LOGIC ---
        function runSimulation(scenario) {
            // Scroll to options to show action is happening
            document.getElementById('step-2-container').scrollIntoView({behavior: 'smooth', block: 'center'});
            
            const step3 = document.getElementById('step-3-container');
            const step4 = document.getElementById('step-4-container');
            const div = document.getElementById('sim-divider');

            // 1. Disable buttons
            document.getElementById('btn-opt-a').disabled = true;
            document.getElementById('btn-opt-b').disabled = true;

            // 2. Determine Data based on Scenario
            let dataBal, dataPeg, textTitle, textDesc;
            const balKeys = { pk: ['VPO', 'BOM_UPDATE'], fk: [] };
            const pegKeys = { pk: ['PO_ID', 'PO_LINE_ID', 'PEGGED_VPO'], fk: ['BOM_UPDATE'] };

            if (scenario === 'A') {
                // CROSS DOCK
                dataBal = tsvData.balAfterA;
                dataPeg = tsvData.pegAfterA;
                textTitle = "Outcome: Cross-Dock Executed";
                textDesc = "<strong>Analysis:</strong> <code>VPO-C05</code> stole <code>PO-100</code> (In-Transit). <code>VPO-C03</code> was forced to take <code>PO-101</code> (Late). <code>VPO-C04</code> is the victim.";
                document.getElementById('card-opt-a').style.backgroundColor = '#ecfdf5';
                document.getElementById('card-opt-a').style.borderColor = '#059669';
                document.getElementById('card-opt-b').style.opacity = '0.5';
                document.getElementById('btn-opt-a').innerHTML = '<i class="fas fa-check"></i> Selected';
                document.getElementById('btn-opt-a').classList.remove('btn-primary');
                document.getElementById('btn-opt-a').style.backgroundColor = '#059669';
                document.getElementById('btn-opt-a').style.color = 'white';
            } else {
                // EXPEDITE
                dataBal = tsvData.balAfterB;
                dataPeg = tsvData.pegAfterB;
                textTitle = "Outcome: Expedite Initiated";
                textDesc = "<strong>Analysis:</strong> <code>VPO-C05</code> took <code>PO-101</code> (Rushed). <code>VPO-C03</code> kept <code>PO-100</code> (Stable). <code>VPO-C04</code> is the victim.";
                document.getElementById('card-opt-b').style.backgroundColor = '#fffbeb';
                document.getElementById('card-opt-b').style.borderColor = '#d97706';
                document.getElementById('card-opt-a').style.opacity = '0.5';
                document.getElementById('btn-opt-b').innerHTML = '<i class="fas fa-plane"></i> Selected';
                document.getElementById('btn-opt-b').style.backgroundColor = '#d97706';
                document.getElementById('btn-opt-b').style.color = 'white';
            }

            // 3. Render Tables
            renderTable('table-bal-after', dataBal, ['REQ_DATE', 'TYPE', 'VPO', 'BOM_UPDATE', 'GROSS_DEMAND', 'SUPPLY', 'ARRIVAL', 'STATUS'], balKeys);
            renderTable('table-peg-after', dataPeg, ['PO_ID', 'PO_LINE_ID', 'PEGGED_VPO', 'BOM_UPDATE', 'PEGGED_QTY'], pegKeys);

            // 4. Update Text
            document.getElementById('res-title-text').innerText = textTitle;
            document.getElementById('res-desc-text').innerHTML = textDesc;

            // 5. Reveal Animation (Delay 600ms)
            setTimeout(() => {
                div.style.display = 'flex';
                step3.style.display = 'grid';
                step4.style.display = 'flex';
                
                // Smooth scroll to results
                step3.scrollIntoView({behavior: 'smooth', block: 'start'});
            }, 600);
        }

        function initInteraction() {
            const btnA = document.getElementById('btn-opt-a');
            const btnB = document.getElementById('btn-opt-b');

            if(btnA) btnA.addEventListener('click', () => runSimulation('A'));
            if(btnB) btnB.addEventListener('click', () => runSimulation('B'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Render
            const balKeys = { pk: ['VPO', 'BOM_UPDATE'], fk: [] };
            const pegKeys = { pk: ['PO_ID', 'PO_LINE_ID', 'PEGGED_VPO'], fk: ['BOM_UPDATE'] };
            const demKeys = { pk:['VPO', 'BOM_UPDATE'], fk:[] };

            renderTable('table-bal-init', tsvData.balInit, ['REQ_DATE', 'TYPE', 'VPO', 'BOM_UPDATE', 'GROSS_DEMAND', 'SUPPLY', 'ARRIVAL', 'STATUS'], balKeys);
            renderTable('table-peg-init', tsvData.pegInit, ['PO_ID', 'PO_LINE_ID', 'PEGGED_VPO', 'BOM_UPDATE', 'PEGGED_QTY'], pegKeys);
            renderTable('table-net-demand', tsvData.netDemand, ['VPO', 'BOM_UPDATE', 'REQ_DATE', 'NET_DEMAND'], demKeys);

            // Setup Buttons
            initInteraction();
        });
    </script>
</body>
</html>
